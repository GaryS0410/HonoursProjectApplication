{% extends "base.html" %}

{% block content %}

<h1> Text Transcription </h1>

<button id="start-button">Start Recording</button>
<button id="stop-button">Stop Recording</button>
<div id="transcription"></div>

<script>
    var recognition = new webkitSpeechRecognition();
    recognition.continous = true;
    recognition.interimREsults = true;

    recognition.onstart = function() {
        console.log('recording started')
    }

    recognition.onresult = function(event) {
        var interim_transcript = '';
        for (var i = event.resultIndex; i < event.results.length; ++i) {
            if (event.results[i].isFinal) {
                $('#transcription').append(event.results[i][0].transcript);
            } else {
                interim_transcript += event.results[i][0].transcript;
            }
        }
    }

    recognition.onerror = function(event) {
        console.log('Error occured in recognition: ' + event.error);
    }

    recognition.onend = function() {
        console.log('recording stopped')
        var blob = new Blob(chunks, {type: 'audio/wav'});
        var formData = new formData();
        formData.append('audio_data', blob, 'recording.wav');
        $.ajax({
            url: '/transcribe',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                $('#transcription').append(response.transcription);
            },
            error: function(xhr, status, error) {
                console.log('Error occured in transcription: ' + error);
            }
        });
    }

    var chunks = [];
    recognition.ondataavailable = function(event) {
        chunks.push(event.data);
    };

    $('#start-button').click(function() {
        recognition.start();
    });

    $('#stop-button').click(function() {
        recognition.stop();
    });
</script>

{% endblock %}