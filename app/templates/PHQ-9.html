{% extends "base.html" %}
{% block title %} PHQ-9 Questionnaire {% endblock %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-steps/1.1.0/jquery.steps.min.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-steps/1.1.0/jquery.steps.min.css">

{% block content %}

{% if score %}

<h1> PHQ-9 Score: {{ score }}</h1>

{% endif %}


<h2> PHQ-9 Questionnaire </h2>

<form id="phq9-form" method="post" action="{{ url_for('main.PHQ9_Questionnaire') }}">
    {{ form.csrf_token }}
    <input type="hidden" id="captruedImage" name="capturedImage">
    <div class="question" id="question1">
        <fieldset>
            <label for="{{ form.question1.id }}">{{ form.question1.label }}</label>
            {{ form.question1 (name='question1')}}
        </fieldset>
    </div>

    <div class="question" id="question2" style="display:none;">
        <fieldset>
            <label for="{{ form.question2.id }}">{{ form.question2.label }}</label>
            {{ form.question2 (name='question2')}}
        </fieldset>
    </div>

    <div class="question" id="question3" style="display:none;">
        <fieldset>
            <label for="{{ form.question3.id }}">{{ form.question3.label }}</label>
            {{ form.question3 (name='question3')}}
        </fieldset>
    </div>

    <div class="question" id="question4" style="display:none;">
        <fieldset>
            <label for="{{ form.question4.id }}">{{ form.question4.label }}</label>
            {{ form.question4 (name='question4')}}
        </fieldset>
    </div>

    <div class="question" id="question5" style="display:none;">
        <fieldset>
            <label for="{{ form.question5.id }}">{{ form.question5.label }}</label>
            {{ form.question5 (name='question5')}}
        </fieldset>
    </div>

    <div class="question" id="question6" style="display:none;">
        <fieldset>
            <label for="{{ form.question6.id }}">{{ form.question6.label }}</label>
            {{ form.question6 (name='question6')}}
        </fieldset>
    </div>

    <div class="question" id="question7" style="display:none;">
        <fieldset>
            <label for="{{ form.question7.id }}">{{ form.question7.label }}</label>
            {{ form.question7 (name='question7')}}
        </fieldset>
    </div>

    <div class="question" id="question8" style="display:none;">
        <fieldset>
            <label for="{{ form.question8.id }}">{{ form.question8.label }}</label>
            {{ form.question8 (name='question8')}}
        </fieldset>
    </div>

    <div class="question" id="question9" style="display:none;">
        <fieldset>
            <label for="{{ form.question9.id }}">{{ form.question9.label }}</label>
            {{ form.question9 (name='question9')}}
        </fieldset>
    </div>
    <button id="snap" type="button" onclick="showNextQuestion()">Next</button>
</form>

<div id="result">
    {% if emotions_count %}
    {% for emotion, count in emotions_count.items() %}
    <p>{{ emotion }}: {{ count }}</p>
    {% endfor %}
    {% endif %}
</div>

<div class="webcam">
    <video id="video" width="640" height="480" autoplay></video>
    <canvas id="webcamCanvas" width="640" height="480" style="display: none;"></canvas>
</div>

<script>
    let canvas = document.querySelector('#webcamCanvas');
    let context = canvas.getContext('2d');
    let video = document.querySelector('#video');

    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: true }).then((stream) => {
            video.srcObject = stream;
            video.play();
        }).catch((err) => {
            console.log('Could not access webcam', err);
            alert("No webcam detected. Please try again with a functioning camera.");
        });
    }

    function fetchData() {
        return fetch('/quizPredict', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ capturedImage: canvas.toDataURL(), })
        })
            .then((response) => {
                console.log(response);
                return response.json();
            })
            .then((data) => {
                console.log(data);
                var result = document.getElementById('result');
                result.innerHTML = '';
                for (var emotion in data.emotions) {
                    result.innerHTML += '<p>' + emotion + ': ' + data.emotions[emotion] + '</p>'
                }
            })
    }

    function upload(file) {
        var formdata = new FormData();
        formdata.append('snap', file);

        fetch('/quizGet', {
            method: 'POST',
            body: formdata,
        })
            .then(response => response.blob())
            .then(data => {
                console.log(data);
            })
            .catch(error => {
                console.error(error);
            })
    }

    function takePhoto() {
        context.drawImage(video, 0, 0, 640, 480);
        canvas.toBlob(upload, 'image/jpeg', 0.95);
    }

    document.getElementById('snap').addEventListener('click', () => {
        takePhoto();
    })

    function showNextQuestion() {
        var currentQuestion = $(".question:visible");
        var nextQuestion = currentQuestion.next(".question");

        if (nextQuestion.length) {
            console.log("Next question...")
            currentQuestion.hide();
            currentQuestion.find("input").prop("disabled", true);
            nextQuestion.show();
            nextQuestion.find("input").prop("disabled", false);
        } else {
            $(".question input").prop("disabled", false);
            $("#phq9-form").submit();
            fetchData(false);
        }
    }


</script>
{% endblock %}